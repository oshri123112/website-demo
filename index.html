<!DOCTYPE html>
<html lang="he">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>מערכת ניהול - מלאה</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <style>
        /* CSS Variables for Themes (עודכן והורחב) */
        :root {
            /* Default Dark Mode */
            --bg-color: #1a1a2e;
            --sidebar-bg: #16213e;
            --card-bg: #0f3460;
            --text-color: #e0e0e0;
            --secondary-text-color: #a0a0a0;
            --accent-color: #e94560;
            --border-color: #0f3460;
            --input-bg: #16213e;
            --button-bg: #e94560;
            --button-hover-bg: #c93450;
            --form-bg: #16213e; /* רקע טופס */
        }

        /* Blue Theme */
        body[data-theme="blue"] {
            --bg-color: #e3f2fd;
            --sidebar-bg: #2196f3;
            --card-bg: #bbdefb;
            --text-color: #1a1a1a;
            --secondary-text-color: #424242;
            --accent-color: #1976d2;
            --border-color: #90caf9;
            --input-bg: #e0f2f7;
            --button-bg: #1976d2;
            --button-hover-bg: #1565c0;
            --form-bg: #e0f2f7;
        }

        /* Red Theme */
        body[data-theme="red"] {
            --bg-color: #ffebee;
            --sidebar-bg: #f44336;
            --card-bg: #ef9a9a;
            --text-color: #1a1a1a;
            --secondary-text-color: #424242;
            --accent-color: #d32f2f;
            --border-color: #ef5350;
            --input-bg: #ffe0b2;
            --button-bg: #d32f2f;
            --button-hover-bg: #c62828;
            --form-bg: #ffe0b2;
        }

        /* Light Brown Theme */
        body[data-theme="lightbrown"] {
            --bg-color: #f5f5dc;
            --sidebar-bg: #d2b48c;
            --card-bg: #ead8c1;
            --text-color: #3e2723;
            --secondary-text-color: #5d4037;
            --accent-color: #8d6e63;
            --border-color: #c0a187;
            --input-bg: #f5deb3;
            --button-bg: #8d6e63;
            --button-hover-bg: #6d4c41;
            --form-bg: #f5deb3;
        }

        /* Base Styles */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
        }

        body {
            display: flex;
            height: 100vh;
            background-color: var(--bg-color);
            color: var(--text-color);
            flex-direction: row; /* Flex direction for sidebar and main content */
            overflow: hidden; /* Prevent body scroll, sections will scroll */
        }

        /* Login Container (חדש) */
        #login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            height: 100%;
            background-color: var(--bg-color);
            position: absolute;
            top: 0;
            left: 0;
            z-index: 1000;
        }

        #login-form {
            background-color: var(--form-bg);
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            text-align: center;
            width: 100%;
            max-width: 400px;
        }

        #login-form h2 {
            margin-bottom: 25px;
            color: var(--accent-color);
        }

        #login-form input[type="email"],
        #login-form input[type="password"] {
            width: calc(100% - 20px);
            padding: 12px;
            margin-bottom: 15px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            background-color: var(--input-bg);
            color: var(--text-color);
            font-size: 16px;
        }

        #login-form button {
            width: 100%;
            padding: 12px 20px;
            background-color: var(--button-bg);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 10px;
        }

        #login-form button:hover {
            background-color: var(--button-hover-bg);
        }

        #login-error-message {
            color: var(--accent-color);
            margin-top: 15px;
            font-weight: bold;
        }

        /* Main Container (עכשיו מוסתר בהתחלה) */
        #main-container {
            display: none; /* מוסתר עד לאחר התחברות */
            flex: 1;
            display: flex;
        }

        .sidebar {
            width: 250px;
            background-color: var(--sidebar-bg);
            padding: 20px;
            display: flex;
            flex-direction: column;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.2);
            z-index: 1; /* Ensure sidebar is above main content for shadow */
        }

        .sidebar-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .sidebar-header h1 {
            color: var(--accent-color);
            font-size: 24px;
        }

        .sidebar-nav ul {
            list-style: none;
            flex-grow: 1; /* Allow nav to take available space */
        }

        .sidebar-nav li {
            margin-bottom: 10px;
        }

        .sidebar-nav a {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            color: var(--text-color);
            text-decoration: none;
            border-radius: 5px;
            transition: background-color 0.2s ease, color 0.2s ease;
        }

        .sidebar-nav a i {
            margin-left: 10px;
            font-size: 18px;
        }

        .sidebar-nav a:hover,
        .sidebar-nav a.active {
            background-color: var(--accent-color);
            color: white;
        }

        .main-content {
            flex-grow: 1;
            padding: 30px;
            overflow-y: auto; /* Enable scrolling for main content */
            position: relative;
            background-color: var(--bg-color);
        }

        .main-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
            position: sticky;
            top: 0;
            background-color: var(--bg-color);
            z-index: 10; /* Ensure header stays on top */
        }

        .main-header h2 {
            font-size: 28px;
            color: var(--text-color);
        }

        .action-buttons button {
            background-color: var(--button-bg);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin-left: 10px;
            transition: background-color 0.2s ease;
        }

        .action-buttons button:hover {
            background-color: var(--button-hover-bg);
        }

        /* Section Styles */
        .section-content {
            display: none; /* Hidden by default */
            padding-top: 20px; /* Space for sticky header */
        }

        .section-content.active {
            display: block;
        }

        /* Cards */
        .card-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .card {
            background-color: var(--card-bg);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            position: relative;
            word-wrap: break-word; /* Ensure text wraps within card */
        }

        .card h3 {
            margin-bottom: 10px;
            color: var(--text-color);
        }

        .card p {
            color: var(--secondary-text-color);
            line-height: 1.5;
            margin-bottom: 10px;
        }

        .card .card-actions {
            margin-top: 15px;
            display: flex;
            gap: 10px;
        }

        .card .card-actions button {
            background-color: var(--accent-color);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s ease;
        }

        .card .card-actions button:hover {
            background-color: var(--button-hover-bg);
        }

        /* Forms */
        .form-section {
            background-color: var(--form-bg);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .form-section label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-color);
            font-weight: bold;
        }

        .form-section input[type="text"],
        .form-section input[type="number"],
        .form-section textarea,
        .form-section select {
            width: calc(100% - 20px); /* Adjust for padding */
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            background-color: var(--input-bg);
            color: var(--text-color);
            font-size: 16px;
        }

        .form-section textarea {
            min-height: 80px;
            resize: vertical;
        }

        .form-section button {
            background-color: var(--button-bg);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.2s ease;
        }

        .form-section button:hover {
            background-color: var(--button-hover-bg);
        }

        /* Table Styles (for Reports/Logs/etc.) */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .data-table th, .data-table td {
            border: 1px solid var(--border-color);
            padding: 12px;
            text-align: left;
            color: var(--text-color);
        }

        .data-table th {
            background-color: var(--sidebar-bg);
            color: var(--accent-color);
            font-weight: bold;
        }

        .data-table tr:nth-child(even) {
            background-color: var(--card-bg);
        }

        .data-table tr:hover {
            background-color: var(--input-bg);
        }

        /* Utility classes */
        .text-center { text-align: center; }
        .text-right { text-align: right; }
        .hidden { display: none !important; }

        /* Theme Selector (חדש) */
        .theme-selector {
            padding: 15px;
            border-top: 1px solid var(--border-color);
            text-align: center;
            margin-top: auto; /* Pushes to the bottom of sidebar */
        }

        .theme-selector label {
            display: block;
            margin-bottom: 10px;
            color: var(--secondary-text-color);
            font-size: 14px;
        }

        .theme-selector select {
            width: 90%;
            padding: 8px;
            border-radius: 5px;
            border: 1px solid var(--border-color);
            background-color: var(--input-bg);
            color: var(--text-color);
            font-size: 14px;
            cursor: pointer;
        }

    </style>
</head>
<body>

    <div id="login-container">
        <form id="login-form">
            <h2>התחברות למערכת</h2>
            <input type="email" id="login-email" placeholder="אימייל" required>
            <input type="password" id="login-password" placeholder="סיסמה" required>
            <button type="submit">התחבר</button>
            <button type="button" id="register-btn">הירשם</button>
            <p id="login-error-message" style="display: none;"></p>
        </form>
    </div>

    <div id="main-container">
        <aside class="sidebar">
            <div class="sidebar-header">
                <h1>ניהול מערכת</h1>
            </div>
            <nav class="sidebar-nav">
                <ul>
                    <li class="active"><a href="#" data-section="dashboard"><i class="fas fa-tachometer-alt"></i> דאשבורד</a></li>
                    <li><a href="#" data-section="tasks"><i class="fas fa-tasks"></i> ניהול משימות</a></li>
                    <li><a href="#" data-section="codes-commands"><i class="fas fa-terminal"></i> קודים ופקודות</a></li>
                    <li><a href="#" data-section="citizens"><i class="fas fa-users"></i> ניהול אזרחים</a></li>
                    <li><a href="#" data-section="reports"><i class="fas fa-chart-line"></i> דוחות</a></li>
                    <li><a href="#" data-section="settings"><i class="fas fa-cog"></i> הגדרות</a></li>
                </ul>
            </nav>
            <div class="theme-selector"> <label for="theme-select">בחר ערכת נושא:</label>
                <select id="theme-select">
                    <option value="dark">כהה (ברירת מחדל)</option>
                    <option value="blue">כחול</option>
                    <option value="red">אדום</option>
                    <option value="lightbrown">חום בהיר</option>
                </select>
            </div>
            <div class="sidebar-footer" style="margin-top: 20px; text-align: center;">
                <button id="logout-btn" style="background-color: #dc3545; color: white; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer;">התנתק</button>
            </div>
        </aside>

        <main class="main-content">
            <header class="main-header">
                <h2 id="main-header-title">דאשבורד</h2>
                <div class="action-buttons" id="current-action-buttons">
                    </div>
            </header>

            <section id="dashboard-section" class="section-content active">
                <div class="card-container">
                    <div class="card">
                        <h3>משימות פתוחות</h3>
                        <p>5 משימות ממתינות לטיפול.</p>
                    </div>
                    <div class="card">
                        <h3>אזרחים רשומים</h3>
                        <p>256 אזרחים במערכת.</p>
                    </div>
                    <div class="card">
                        <h3>דיווחים חדשים</h3>
                        <p>3 דיווחים חדשים לבדיקה.</p>
                    </div>
                </div>
            </section>

            <section id="tasks-section" class="section-content">
                <div class="form-section">
                    <h3>הוסף משימה חדשה</h3>
                    <label for="task-title">כותרת משימה:</label>
                    <input type="text" id="task-title" placeholder="הזן כותרת משימה" required>
                    <label for="task-description">תיאור:</label>
                    <textarea id="task-description" placeholder="תיאור מפורט של המשימה"></textarea>
                    <button id="addTaskBtn">הוסף משימה</button>
                </div>
                <div class="card-container" id="tasks-list">
                    </div>
            </section>

            <section id="codes-commands-section" class="section-content">
                <div class="form-section">
                    <h3>הוסף קוד/פקודה חדשה</h3>
                    <label for="code-name">שם הקוד/פקודה:</label>
                    <input type="text" id="code-name" placeholder="הזן שם" required>
                    <label for="code-value">ערך הקוד/פקודה:</label>
                    <textarea id="code-value" placeholder="הזן את הקוד או הפקודה"></textarea>
                    <button id="addCodeCommandBtn">הוסף קוד/פקודה</button>
                </div>
                <div class="card-container" id="codes-commands-list">
                    </div>
            </section>

            <section id="citizens-section" class="section-content">
                <div class="form-section">
                    <h3>הוסף אזרח חדש</h3>
                    <label for="citizen-name">שם אזרח:</label>
                    <input type="text" id="citizen-name" placeholder="הזן שם אזרח" required>
                    <label for="citizen-id">מספר ת"ז/מזהה:</label>
                    <input type="text" id="citizen-id" placeholder="הזן תעודת זהות/מזהה">
                    <button id="addCitizenBtn">הוסף אזרח</button>
                </div>
                <div class="card-container" id="citizens-list">
                    </div>
            </section>

            <section id="reports-section" class="section-content">
                <h3>דוחות ונתונים</h3>
                <p>כאן יופיעו דוחות שונים וגרפים. פונקציונליות זו דורשת פיתוח נוסף.</p>
                <div class="data-table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>תאריך</th>
                                <th>סוג דיווח</th>
                                <th>סטטוס</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>2024-06-25</td>
                                <td>דיווח תקלות</td>
                                <td>פתוח</td>
                            </tr>
                            <tr>
                                <td>2024-06-24</td>
                                <td>בקשת מידע</td>
                                <td>סגור</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <section id="settings-section" class="section-content">
                <h3>הגדרות מערכת</h3>
                <p>כאן ניתן להגדיר הגדרות שונות למערכת. פונקציונליות זו דורשת פיתוח נוסף.</p>
                <div class="form-section">
                    <label for="webhook-url">כתובת Webhook לדיסקורד (כללי):</label>
                    <input type="text" id="webhook-url" placeholder="הזן כתובת webhook">
                    <button id="save-webhook-btn">שמור הגדרות Webhook</button>
                </div>
            </section>

        </main>
    </div>

    <script>
        // Firebase Configuration (החלף בפרטי הפרויקט שלך)
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_AUTH_DOMAIN",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Firebase Collections (חדש)
        const tasksCollection = db.collection('tasks');
        const codesCommandsCollection = db.collection('codesCommands');
        const citizensCollection = db.collection('citizens');
        const settingsCollection = db.collection('settings'); // For Webhook URL

        // DOM Elements
        const mainContainer = document.getElementById('main-container');
        const loginContainer = document.getElementById('login-container');
        const loginForm = document.getElementById('login-form');
        const loginEmailInput = document.getElementById('login-email');
        const loginPasswordInput = document.getElementById('login-password');
        const loginErrorMessage = document.getElementById('login-error-message');
        const registerBtn = document.getElementById('register-btn');
        const logoutBtn = document.getElementById('logout-btn');

        const sidebarNavLinks = document.querySelectorAll('.sidebar-nav a');
        const mainHeaderTitle = document.getElementById('main-header-title');
        const currentActionButtons = document.getElementById('current-action-buttons');

        // Theme Selector
        const themeSelect = document.getElementById('theme-select');

        // Webhook URL (Managed by Firebase now)
        let WEBHOOK_URLS = {
            general: '', // Will be loaded from Firebase
            tasks: '',
            codesCommands: '',
            citizens: ''
        };

        // --- Authentication Logic (חדש) ---
        auth.onAuthStateChanged(user => {
            if (user) {
                // User is signed in
                loginContainer.style.display = 'none';
                mainContainer.style.display = 'flex';
                loadSettings(); // Load webhook settings after login
                loadInitialData(); // Load data from Firestore
                applySavedTheme(); // Apply theme after user is logged in and main container is visible
                console.log('User logged in:', user.email);
            } else {
                // User is signed out
                loginContainer.style.display = 'flex';
                mainContainer.style.display = 'none';
                console.log('User logged out.');
            }
        });

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = loginEmailInput.value;
            const password = loginPasswordInput.value;
            try {
                await auth.signInWithEmailAndPassword(email, password);
                loginErrorMessage.style.display = 'none';
            } catch (error) {
                loginErrorMessage.textContent = `שגיאת התחברות: ${error.message}`;
                loginErrorMessage.style.display = 'block';
                console.error('Login Error:', error);
            }
        });

        registerBtn.addEventListener('click', async () => {
            const email = loginEmailInput.value;
            const password = loginPasswordInput.value;
            if (!email || !password) {
                loginErrorMessage.textContent = 'אנא הזן אימייל וסיסמה כדי להירשם.';
                loginErrorMessage.style.display = 'block';
                return;
            }
            try {
                await auth.createUserWithEmailAndPassword(email, password);
                loginErrorMessage.style.display = 'none';
                alert('הרשמה מוצלחת! כעת תוכל להתחבר.');
            } catch (error) {
                loginErrorMessage.textContent = `שגיאת הרשמה: ${error.message}`;
                loginErrorMessage.style.display = 'block';
                console.error('Registration Error:', error);
            }
        });

        logoutBtn.addEventListener('click', async () => {
            try {
                await auth.signOut();
            } catch (error) {
                console.error('Logout Error:', error);
            }
        });

        // --- Theme Switching Logic (חדש) ---
        function applyTheme(theme) {
            document.body.setAttribute('data-theme', theme);
            localStorage.setItem('selectedTheme', theme); // Save user preference
            themeSelect.value = theme; // Update dropdown
        }

        function applySavedTheme() {
            const savedTheme = localStorage.getItem('selectedTheme') || 'dark'; // Default to dark
            applyTheme(savedTheme);
        }

        themeSelect.addEventListener('change', (e) => {
            applyTheme(e.target.value);
        });

        // --- Webhook Settings (עכשיו מנוהל ב-Firebase Firestore) ---
        const webhookUrlInput = document.getElementById('webhook-url');
        const saveWebhookBtn = document.getElementById('save-webhook-btn');

        async function loadSettings() {
            try {
                const doc = await settingsCollection.doc('webhookUrls').get();
                if (doc.exists) {
                    WEBHOOK_URLS = { ...WEBHOOK_URLS, ...doc.data() };
                    webhookUrlInput.value = WEBHOOK_URLS.general || '';
                    console.log('Webhook settings loaded from Firebase:', WEBHOOK_URLS);
                } else {
                    console.log('No webhook settings found in Firebase.');
                }
            } catch (error) {
                console.error('Error loading settings:', error);
            }
        }

        saveWebhookBtn.addEventListener('click', async () => {
            const generalUrl = webhookUrlInput.value;
            WEBHOOK_URLS.general = generalUrl;
            WEBHOOK_URLS.tasks = generalUrl; // Apply general to others for simplicity
            WEBHOOK_URLS.codesCommands = generalUrl;
            WEBHOOK_URLS.citizens = generalUrl;

            try {
                await settingsCollection.doc('webhookUrls').set(WEBHOOK_URLS);
                alert('הגדרות Webhook נשמרו בהצלחה ב-Firebase!');
                console.log('Webhook settings saved to Firebase:', WEBHOOK_URLS);
            } catch (error) {
                console.error('Error saving webhook settings:', error);
                alert('שגיאה בשמירת הגדרות Webhook.');
            }
        });

        // --- Discord Webhook Function (ללא שינוי מהותי, משתמש ב-WEBHOOK_URLS) ---
        async function sendDiscordMessage(webhookUrl, message, sourceName) {
            if (!webhookUrl) {
                console.warn(`Webhook URL for ${sourceName} is not configured.`);
                return;
            }
            try {
                const response = await fetch(webhookUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ content: message }),
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error(`Failed to send Discord message from ${sourceName}:`, response.status, errorText);
                    alert(`שגיאה בשליחת הודעה לדיסקורד מ${sourceName}: ${response.status} - ${errorText}`);
                } else {
                    console.log(`Message sent successfully to Discord from ${sourceName}.`);
                }
            } catch (error) {
                console.error(`Network error sending Discord message from ${sourceName}:`, error);
                alert(`שגיאת רשת בשליחת הודעה לדיסקורד מ${sourceName}: ${error.message}`);
            }
        }

        // --- General UI Logic ---
        function showSection(sectionId) {
            document.querySelectorAll('.section-content').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(sectionId).classList.add('active');
        }

        function updateMainHeaderTitle(title) {
            mainHeaderTitle.textContent = title;
        }

        function updateActionButtons(sectionId) {
            currentActionButtons.innerHTML = ''; // Clear existing buttons
            if (sectionId === 'tasks-section') {
                // No specific action buttons needed for tasks, as the add button is in the form
            } else if (sectionId === 'codes-commands-section') {
                // No specific action buttons needed
            } else if (sectionId === 'citizens-section') {
                // No specific action buttons needed
            }
            // Add more conditions for other sections if needed
        }

        sidebarNavLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                document.querySelectorAll('.sidebar-nav li').forEach(li => li.classList.remove('active'));
                link.closest('li').classList.add('active');

                const sectionId = link.dataset.section + '-section';
                const sectionTitle = link.textContent.trim();
                showSection(sectionId);
                updateMainHeaderTitle(sectionTitle);
                updateActionButtons(sectionId);
            });
        });

        // --- Firebase Data Management and Rendering (עודכן ל-Firestore) ---

        // Tasks
        const tasksList = document.getElementById('tasks-list');
        const addTaskBtn = document.getElementById('addTaskBtn');
        const taskTitleInput = document.getElementById('task-title');
        const taskDescriptionInput = document.getElementById('task-description');

        async function renderTasks() {
            tasksList.innerHTML = ''; // Clear current list
            try {
                const snapshot = await tasksCollection.orderBy('createdAt', 'desc').get();
                if (snapshot.empty) {
                    tasksList.innerHTML = '<p style="color: var(--secondary-text-color); text-align: center;">אין משימות להצגה.</p>';
                    return;
                }
                snapshot.forEach(doc => {
                    const task = doc.data();
                    const taskId = doc.id;
                    const card = document.createElement('div');
                    card.classList.add('card');
                    card.innerHTML = `
                        <h3>${task.title}</h3>
                        <p>${task.description}</p>
                        <div class="card-actions">
                            <button onclick="markTaskCompleted('${taskId}')">סמן כבוצע</button>
                            <button style="background-color: #dc3545;" onclick="deleteTask('${taskId}', '${task.title}')">מחק</button>
                        </div>
                    `;
                    tasksList.appendChild(card);
                });
            } catch (error) {
                console.error('Error rendering tasks:', error);
                tasksList.innerHTML = '<p style="color: var(--accent-color); text-align: center;">שגיאה בטעינת משימות.</p>';
            }
        }

        addTaskBtn.addEventListener('click', async () => {
            const title = taskTitleInput.value.trim();
            const description = taskDescriptionInput.value.trim();
            if (title) {
                try {
                    await tasksCollection.add({
                        title: title,
                        description: description,
                        completed: false,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    const message = `**משימה חדשה נוספה:**\nכותרת: ${title}\nתיאור: ${description || 'לא צוין'}`;
                    await sendDiscordMessage(WEBHOOK_URLS.tasks, message, 'מערכת משימות');
                    alert(`משימה "${title}" נוספה בהצלחה.`);
                    taskTitleInput.value = '';
                    taskDescriptionInput.value = '';
                    renderTasks(); // Re-render tasks after adding
                } catch (error) {
                    console.error('Error adding task:', error);
                    alert('שגיאה בהוספת משימה.');
                }
            } else {
                alert('אנא הזן כותרת למשימה.');
            }
        });

        async function markTaskCompleted(taskId) {
            try {
                await tasksCollection.doc(taskId).update({ completed: true });
                alert('המשימה סומנה כבוצעה.');
                // Optional: Send Discord message for completion
                // const task = (await tasksCollection.doc(taskId).get()).data();
                // await sendDiscordMessage(WEBHOOK_URLS.tasks, `**משימה בוצעה:** ${task.title}`, 'מערכת משימות');
                renderTasks();
            } catch (error) {
                console.error('Error marking task completed:', error);
                alert('שגיאה בסימון משימה כבוצעה.');
            }
        }

        async function deleteTask(taskId, taskTitle) {
            if (confirm(`האם אתה בטוח שברצונך למחוק את המשימה "${taskTitle}"?`)) {
                try {
                    await tasksCollection.doc(taskId).delete();
                    const message = `**משימה נמחקה:** ${taskTitle}`;
                    await sendDiscordMessage(WEBHOOK_URLS.tasks, message, 'מערכת משימות');
                    alert(`משימה "${taskTitle}" נמחקה.`);
                    renderTasks(); // Re-render tasks after deletion
                } catch (error) {
                    console.error('Error deleting task:', error);
                    alert('שגיאה במחיקת משימה.');
                }
            }
        }

        // Codes & Commands
        const codesCommandsList = document.getElementById('codes-commands-list');
        const addCodeCommandBtn = document.getElementById('addCodeCommandBtn');
        const codeNameInput = document.getElementById('code-name');
        const codeValueInput = document.getElementById('code-value');

        async function renderCodesCommands() {
            codesCommandsList.innerHTML = ''; // Clear current list
            try {
                const snapshot = await codesCommandsCollection.orderBy('createdAt', 'desc').get();
                if (snapshot.empty) {
                    codesCommandsList.innerHTML = '<p style="color: var(--secondary-text-color); text-align: center;">אין קודים או פקודות להצגה.</p>';
                    return;
                }
                snapshot.forEach(doc => {
                    const item = doc.data();
                    const itemId = doc.id;
                    const card = document.createElement('div');
                    card.classList.add('card');
                    card.innerHTML = `
                        <h3>${item.name}</h3>
                        <p><strong>ערך:</strong> ${item.value}</p>
                        <div class="card-actions">
                            <button onclick="copyToClipboard('${item.value}', 'קוד/פקודה')">העתק</button>
                            <button style="background-color: #dc3545;" onclick="deleteCodeCommand('${itemId}', '${item.name}')">מחק</button>
                        </div>
                    `;
                    codesCommandsList.appendChild(card);
                });
            } catch (error) {
                console.error('Error rendering codes/commands:', error);
                codesCommandsList.innerHTML = '<p style="color: var(--accent-color); text-align: center;">שגיאה בטעינת קודים/פקודות.</p>';
            }
        }

        addCodeCommandBtn.addEventListener('click', async () => {
            const name = codeNameInput.value.trim();
            const value = codeValueInput.value.trim();
            if (name && value) {
                try {
                    await codesCommandsCollection.add({
                        name: name,
                        value: value,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    const message = `**קוד/פקודה חדשה נוספה:**\nשם: ${name}\nערך: ${value}`;
                    await sendDiscordMessage(WEBHOOK_URLS.codesCommands, message, 'מערכת קודים & פקודות');
                    alert(`קוד/פקודה "${name}" נוספה בהצלחה.`);
                    codeNameInput.value = '';
                    codeValueInput.value = '';
                    renderCodesCommands();
                } catch (error) {
                    console.error('Error adding code/command:', error);
                    alert('שגיאה בהוספת קוד/פקודה.');
                }
            } else {
                alert('אנא הזן שם וערך לקוד/פקודה.');
            }
        });

        async function deleteCodeCommand(itemId, itemName) {
            if (confirm(`האם אתה בטוח שברצונך למחוק את הקוד/פקודה "${itemName}"?`)) {
                try {
                    await codesCommandsCollection.doc(itemId).delete();
                    const message = `**קוד/פקודה נמחקה:** ${itemName}`;
                    await sendDiscordMessage(WEBHOOK_URLS.codesCommands, message, 'מערכת קודים & פקודות');
                    alert(`קוד/פקודה "${itemName}" נמחקה.`);
                    renderCodesCommands();
                } catch (error) {
                    console.error('Error deleting code/command:', error);
                    alert('שגיאה במחיקת קוד/פקודה.');
                }
            }
        }

        // Citizens
        const citizensList = document.getElementById('citizens-list');
        const addCitizenBtn = document.getElementById('addCitizenBtn');
        const citizenNameInput = document.getElementById('citizen-name');
        const citizenIdInput = document.getElementById('citizen-id');

        async function renderCitizens() {
            citizensList.innerHTML = ''; // Clear current list
            try {
                const snapshot = await citizensCollection.orderBy('createdAt', 'desc').get();
                if (snapshot.empty) {
                    citizensList.innerHTML = '<p style="color: var(--secondary-text-color); text-align: center;">אין אזרחים להצגה.</p>';
                    return;
                }
                snapshot.forEach(doc => {
                    const citizen = doc.data();
                    const citizenId = doc.id;
                    const card = document.createElement('div');
                    card.classList.add('card');
                    card.innerHTML = `
                        <h3>${citizen.name}</h3>
                        <p><strong>מזהה:</strong> ${citizen.id || 'לא צוין'}</p>
                        <div class="card-actions">
                            <button style="background-color: #dc3545;" onclick="deleteCitizen('${citizenId}', '${citizen.name}')">מחק</button>
                        </div>
                    `;
                    citizensList.appendChild(card);
                });
            } catch (error) {
                console.error('Error rendering citizens:', error);
                citizensList.innerHTML = '<p style="color: var(--accent-color); text-align: center;">שגיאה בטעינת אזרחים.</p>';
            }
        }

        addCitizenBtn.addEventListener('click', async () => {
            const name = citizenNameInput.value.trim();
            const id = citizenIdInput.value.trim();
            if (name) {
                try {
                    await citizensCollection.add({
                        name: name,
                        id: id,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    const message = `**אזרח חדש נוסף:**\nשם: ${name}\nמזהה: ${id || 'לא צוין'}`;
                    await sendDiscordMessage(WEBHOOK_URLS.citizens, message, 'מערכת אזרחים');
                    alert(`אזרח "${name}" נוסף בהצלחה.`);
                    citizenNameInput.value = '';
                    citizenIdInput.value = '';
                    renderCitizens();
                } catch (error) {
                    console.error('Error adding citizen:', error);
                    alert('שגיאה בהוספת אזרח.');
                }
            } else {
                alert('אנא הזן שם אזרח.');
            }
        });

        async function deleteCitizen(citizenDocId, citizenName) {
            if (confirm(`האם אתה בטוח שברצונך למחוק את האזרח "${citizenName}"?`)) {
                try {
                    await citizensCollection.doc(citizenDocId).delete();
                    const message = `**אזרח נמחק:** ${citizenName}`;
                    await sendDiscordMessage(WEBHOOK_URLS.citizens, message, 'מערכת אזרחים');
                    alert(`אזרח "${citizenName}" נמחק.`);
                    renderCitizens();
                } catch (error) {
                    console.error('Error deleting citizen:', error);
                    alert('שגיאה במחיקת אזרח.');
                }
            }
        }

        // --- Utility Functions ---
        function copyToClipboard(text, itemType) {
            navigator.clipboard.writeText(text).then(() => {
                alert(`${itemType} הועתק ללוח!`);
            }).catch(err => {
                console.error('Failed to copy: ', err);
                alert(`שגיאה בהעתקת ${itemType}.`);
            });
        }

        // --- Initial Load ---
        function loadInitialData() {
            const initialSectionId = document.querySelector('.sidebar-nav li.active a').dataset.section + '-section';
            const initialSectionTitle = document.querySelector('.sidebar-nav li.active a').textContent.trim();
            showSection(initialSectionId);
            updateMainHeaderTitle(initialSectionTitle);
            updateActionButtons(initialSectionId);

            // Render data for active section if it's not dashboard
            if (initialSectionId === 'tasks-section') {
                renderTasks();
            } else if (initialSectionId === 'codes-commands-section') {
                renderCodesCommands();
            } else if (initialSectionId === 'citizens-section') {
                renderCitizens();
            }
            // Add more sections here if they need initial data loading
        }

        // Listen for changes in sections to re-render data (if Firebase data is updated externally)
        // Note: For real-time updates, you would use .onSnapshot()
        // For simplicity and to match previous behavior, manual re-render on section switch
        document.querySelectorAll('.sidebar-nav a').forEach(link => {
            link.addEventListener('click', () => {
                const sectionId = link.dataset.section + '-section';
                if (sectionId === 'tasks-section') {
                    renderTasks();
                } else if (sectionId === 'codes-commands-section') {
                    renderCodesCommands();
                } else if (sectionId === 'citizens-section') {
                    renderCitizens();
                }
            });
        });

        // Initialize settings and theme on page load (before auth check completes)
        // applySavedTheme(); // This is now called after auth.onAuthStateChanged completes
    </script>
</body>
</html>
